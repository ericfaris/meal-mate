# Stage 1: Build
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# Stage 2: Production
FROM node:20-alpine
WORKDIR /app

# Define build arguments
ARG MONGODB_URI
ARG PORT
ARG JWT_SECRET
ARG GOOGLE_CLIENT_ID
ARG GOOGLE_WEB_CLIENT_ID
ARG GOOGLE_ANDROID_CLIENT
ARG ANTHROPIC_API_KEY
ARG UNSPLASH_ACCESS_KEY
ARG GOOGLE_API_KEY
ARG GOOGLE_CSE_ID

# Set as environment variables
ENV MONGODB_URI=${MONGODB_URI}
ENV PORT=${PORT}
ENV JWT_SECRET=${JWT_SECRET}
ENV GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
ENV GOOGLE_WEB_CLIENT_ID=${GOOGLE_WEB_CLIENT_ID}
ENV GOOGLE_ANDROID_CLIENT=${GOOGLE_ANDROID_CLIENT}
ENV ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
ENV UNSPLASH_ACCESS_KEY=${UNSPLASH_ACCESS_KEY}
ENV GOOGLE_API_KEY=${GOOGLE_API_KEY}
ENV GOOGLE_CSE_ID=${GOOGLE_CSE_ID}

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package*.json ./
RUN npm ci --omit=dev
EXPOSE ${PORT}
CMD ["node", "dist/server.js"]
